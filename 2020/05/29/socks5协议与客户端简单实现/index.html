<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    socks5协议与客户端简单实现 |
    
    frank0&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="frank0's Blog" type="application/atom+xml">
</head>

<body>
<main class="content">
  <section class="outer">
  <article id="post-socks5协议与客户端简单实现" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h1 class="article-title" itemprop="name">
      socks5协议与客户端简单实现
    </h1>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/05/29/socks5%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2020-05-29T09:40:05.000Z" itemprop="datePublished">2020-05-29</time>
</a>
                            
                    </div>
                    

                        
                            
    <div class="tocbot"></div>





                                

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <blockquote>
<p>在国内，如果想要访问google等被封锁的网站，我们想要翻墙，一直以来都是自己搭建翻墙软件，有一些一键部署脚本，今天受一个朋友委托想要做手机端的代理软件，所以就研究了一下这个协议；为以后开发android的代理软件（并非FQ软件）打下基础。</p>
</blockquote>
<a id="more"></a>


<p>首先，socks5协议并非网络编程中的sockets，socks是一种协议最新版本应该是socks5;而sockets是一种网络编程方法,是一种工具，就像打电话，socks5可以理解为某种交流语言，而sockets是电话。</p>
<p>socks协议是会话层协议，这就表明，他可以无视会话层之上的协议，如http等应用层协议,也就是说可以代理HTTP等上层协议；由于是会话层协议，所以他依赖TCP/IP协议。</p>
<p>著名的shadowsocks就是基于此协议，但是shadowsocks提供了丰富的加密功能，而<code>socks5是不具备加密功能的</code>。</p>
<p>socks协议有很多版本，如socks4,socks4a,socks5 最新版本是socks5,提供了UDP代理，认证，IPV6功能。</p>
<p>这次主要研究socks5；</p>
<p>需要注意的是，当客户端与服务器端<code>建立TCP连接之后</code>才会根据<code>socks5协议进行握手</code>。</p>
<p>socks5协议内容(<code>以字节为单位</code>):</p>
<h5 id="客户端请求握手"><a href="#客户端请求握手" class="headerlink" title="客户端请求握手"></a>客户端请求握手</h5><p>建立连接之后，客户端发出握手请求：</p>
<table>
<thead>
<tr>
<th>VER</th>
<th>NMETHODS</th>
<th>METHODS</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>1-255</td>
</tr>
</tbody></table>
<ul>
<li><p>VER是SOCKS版本，这里应该是0x05</p>
</li>
<li><p>NMETHODS是METHODS部分的长度</p>
</li>
<li><p>METHODS是客户端支持的认证方式列表，每个方法占1字节。当前的定义是：</p>
<ul>
<li>0x00 不需要认证 (常用)</li>
<li>0x01 GSSAPI</li>
<li>0x02 用户名、密码认证 (常用)</li>
<li>0x03 - 0x7F由IANA分配（保留）</li>
<li>0x80 - 0xFE为私人方法保留</li>
<li>0xFF 无可接受的方法</li>
</ul>
</li>
</ul>
<h5 id="服务端回应握手信息"><a href="#服务端回应握手信息" class="headerlink" title="服务端回应握手信息"></a>服务端回应握手信息</h5><table>
<thead>
<tr>
<th>VER</th>
<th>METHOD</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<ul>
<li>VER是SOCKS版本，这里应该是0x05；</li>
<li>METHOD是服务端选中的方法。如果返回0xFF表示没有一个认证方法被选中，客户端需要关闭连接。</li>
</ul>
<p>如果服务端允许直接访问或者用户名密码认证访问,Method 应该是0x00或者是0x02</p>
<h5 id="客户端发送认证请求"><a href="#客户端发送认证请求" class="headerlink" title="客户端发送认证请求"></a>客户端发送认证请求</h5><table>
<thead>
<tr>
<th>鉴定协议版本</th>
<th>用户名长度</th>
<th>用户名</th>
<th>密码长度</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>动态</td>
<td>1</td>
<td>动态</td>
</tr>
</tbody></table>
<p>协议版本目前固定为 0x01</p>
<p>这里必须要注意一下，用户名长度与密码长度；</p>
<p>一般用户名和密码都是字符串，这里需要把 String-&gt;16进制字符串-&gt;byte数组 ;这个长度就是数组的长度。</p>
<p>用户名与密码都传入这个byte数组就行。</p>
<p>为什么是16进制？16进制比较好认。</p>
<h5 id="服务器认证应答"><a href="#服务器认证应答" class="headerlink" title="服务器认证应答"></a>服务器认证应答</h5><table>
<thead>
<tr>
<th>鉴定协议版本</th>
<th>鉴定状态</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<p>协议版本目前固定为 0x01</p>
<p>其中鉴定状态 0x00 表示成功，0x01 表示失败。</p>
<p>认证成功之后，客户端就可以发送请求信息，比如 客户端需要访问baidu.com就需要发送请求信心，让服务端去请求baidu.com</p>
<h5 id="客户端请求命令"><a href="#客户端请求命令" class="headerlink" title="客户端请求命令"></a>客户端请求命令</h5><table>
<thead>
<tr>
<th>VER</th>
<th>CMD</th>
<th>RSV</th>
<th>ATYP</th>
<th>DST.ADDR</th>
<th>DST.PORT</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>0x00</td>
<td>1</td>
<td>动态</td>
<td>2</td>
</tr>
</tbody></table>
<ul>
<li><p>VER是SOCKS版本，这里应该是0x05；</p>
</li>
<li><p>CMD是SOCK的命令码</p>
<ul>
<li>0x01表示CONNECT请求</li>
<li>0x02表示BIND请求</li>
<li>0x03表示UDP转发</li>
</ul>
</li>
<li><p>RSV 0x00，保留</p>
</li>
<li><p>ATYP DST.ADDR类型</p>
<ul>
<li>0x01 IPv4地址，DST.ADDR部分4字节长度</li>
<li>0x03 域名，DST.ADDR部分第一个字节为域名长度，DST.ADDR剩余的内容为域名，没有\0结尾。</li>
<li>0x04 IPv6地址，16个字节长度。</li>
</ul>
</li>
<li><p>DST.ADDR 目的地址</p>
</li>
<li><p>DST.PORT 网络字节序表示的目的端口</p>
</li>
</ul>
<p>这里也需要注意一下，socks5是支持域名解析的，所以一般我们请求的时候直接使用域名发出请求。</p>
<p>服务端进行请求是，如果是IP则直接进行IP进行请求，如果是域名需要进行解析才能请求。</p>
<p>DST.ADDR这个字段一般是域名字符串的byte数组。</p>
<h5 id="服务端请求命令应答"><a href="#服务端请求命令应答" class="headerlink" title="服务端请求命令应答"></a>服务端请求命令应答</h5><table>
<thead>
<tr>
<th>VER</th>
<th>REP</th>
<th>RSV</th>
<th>ATYP</th>
<th>BND.ADDR</th>
<th>BND.PORT</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>0x00</td>
<td>1</td>
<td>动态</td>
<td>2</td>
</tr>
</tbody></table>
<ul>
<li><p>VER是SOCKS版本，这里应该是0x05；</p>
</li>
<li><p>REP应答字段</p>
<ul>
<li>0x00表示成功</li>
<li>0x01普通SOCKS服务器连接失败</li>
<li>0x02现有规则不允许连接</li>
<li>0x03网络不可达</li>
<li>0x04主机不可达</li>
<li>0x05连接被拒</li>
<li>0x06 TTL超时</li>
<li>0x07不支持的命令</li>
<li>0x08不支持的地址类型</li>
<li>0x09 - 0xFF未定义</li>
</ul>
</li>
<li><p>RSV 0x00，保留</p>
</li>
<li><p>ATYP BND.ADDR类型</p>
<ul>
<li>0x01 IPv4地址，DST.ADDR部分4字节长度</li>
<li>0x03域名，DST.ADDR部分第一个字节为域名长度，DST.ADDR剩余的内容为域名，没有\0结尾。</li>
<li>0x04 IPv6地址，16个字节长度。</li>
</ul>
</li>
<li><p>BND.ADDR 服务器绑定的地址</p>
</li>
<li><p>BND.PORT 网络字节序表示的服务器绑定的端口</p>
</li>
</ul>
<p>其实跟请求一样，我们需要关注的REP应答字段，可以打印日志，判断是否连接成功。</p>
<hr>
<p>以上算是握手成功，之后就是数据正常传输，比如客户端访问baidu.com的HTTP数据包，发送到socks服务器，socks服务器访问之后，把响应如实返回给客户端，这就是代理。</p>
<h5 id="最后在来个实例（部分Java代码）"><a href="#最后在来个实例（部分Java代码）" class="headerlink" title="最后在来个实例（部分Java代码）"></a>最后在来个实例（部分Java代码）</h5><p>请求握手，协议版本05,客户端只支持用户名和密码认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buffer.clear();</span><br><span class="line">buffer.put((<span class="keyword">byte</span>)<span class="number">0x05</span>);</span><br><span class="line">buffer.put((<span class="keyword">byte</span>)<span class="number">0x01</span>);</span><br><span class="line">buffer.put(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x02</span>&#125;);</span><br><span class="line">buffer.flip();</span><br><span class="line"><span class="keyword">if</span>(write(buffer, <span class="keyword">true</span>))&#123;</span><br><span class="line">  SOCKS_PHASE = <span class="number">1</span>;</span><br><span class="line">  beginReceive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端响应：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9gatugn8j314g044dgj.jpg" alt="image-20200529173135516"></p>
<p>客户端构造认证请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">byte</span>[] arrayOfByte1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">   <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">this</span>.m_Config.Username.getBytes();</span><br><span class="line">   <span class="keyword">byte</span>[] arrayOfByte2 = <span class="keyword">this</span>.m_Config.Password.getBytes();</span><br><span class="line">   <span class="keyword">int</span> i = <span class="keyword">this</span>.m_Config.Username.length();</span><br><span class="line">   <span class="keyword">int</span> j = <span class="keyword">this</span>.m_Config.Password.length();</span><br><span class="line"><span class="comment">//用户名与密码</span></span><br><span class="line">   arrayOfByte = StringUtil.getByteArrayByHex(<span class="keyword">this</span>.m_Config.Username);</span><br><span class="line">   arrayOfByte2 = StringUtil.getByteArrayByHex(<span class="keyword">this</span>.m_Config.Password);</span><br><span class="line">   <span class="keyword">int</span> k = i+<span class="number">3</span>;</span><br><span class="line">   arrayOfByte1 = <span class="keyword">new</span> <span class="keyword">byte</span>[k+j];</span><br><span class="line">   arrayOfByte1[<span class="number">0</span>] = <span class="number">0x01</span>;</span><br><span class="line">   arrayOfByte1[<span class="number">1</span>] = IntToByte(i)[<span class="number">3</span>];</span><br><span class="line">   System.arraycopy(arrayOfByte, <span class="number">0</span>, arrayOfByte1, <span class="number">2</span>, i);</span><br><span class="line">   arrayOfByte1[i + <span class="number">2</span>] = IntToByte(j)[<span class="number">3</span>];</span><br><span class="line">   System.arraycopy(arrayOfByte2, <span class="number">0</span>, arrayOfByte1, k, j);</span><br><span class="line">   paramByteBuffer.clear();</span><br><span class="line">   paramByteBuffer.put(arrayOfByte1);</span><br><span class="line">   paramByteBuffer.flip();</span><br></pre></td></tr></table></figure>

<p>服务端响应：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf9gbr9g4aj316s064wfd.jpg" alt="image-20200529173231196"></p>
<p>构造请求命令数据包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//校验认证是否成功？</span></span><br><span class="line"><span class="keyword">if</span> (data.length != <span class="number">2</span>)</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">if</span> (data[<span class="number">0</span>]==<span class="number">0x01</span> &amp;&amp; data[<span class="number">1</span>] ==<span class="number">0x00</span>)&#123;</span><br><span class="line">  System.out.println(<span class="string">"认证成功，继续"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  System.out.println(<span class="string">"认证失败"</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//组装命令过程数据</span></span><br><span class="line"><span class="keyword">byte</span>[] arrayOfByte1 = <span class="keyword">this</span>.m_DestAddress.getHostName().getBytes();</span><br><span class="line"><span class="keyword">byte</span>[] portArrayOfByte = unsignedShortToByte2((<span class="keyword">short</span>)<span class="keyword">this</span>.m_DestAddress.getPort());</span><br><span class="line"><span class="keyword">byte</span>[] arrayOfByte2 = <span class="keyword">new</span> <span class="keyword">byte</span>[arrayOfByte1.length + <span class="number">5</span> + portArrayOfByte.length];</span><br><span class="line">arrayOfByte2[<span class="number">0</span>] = <span class="number">5</span>;</span><br><span class="line">arrayOfByte2[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">arrayOfByte2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">arrayOfByte2[<span class="number">3</span>] = <span class="number">3</span>;</span><br><span class="line">arrayOfByte2[<span class="number">4</span>] = (<span class="keyword">byte</span>)arrayOfByte1.length;</span><br><span class="line">System.arraycopy(arrayOfByte1, <span class="number">0</span>, arrayOfByte2, <span class="number">5</span>, arrayOfByte1.length);</span><br><span class="line">System.arraycopy(portArrayOfByte, <span class="number">0</span>, arrayOfByte2, arrayOfByte1.length + <span class="number">5</span>, portArrayOfByte.length);</span><br><span class="line">paramByteBuffer.clear();</span><br><span class="line">paramByteBuffer.put(arrayOfByte2);</span><br><span class="line">paramByteBuffer.flip();</span><br></pre></td></tr></table></figure>

<p>服务端响应：</p>
<p><img src="../../images/20200529173805.png" alt=""></p>
<p>可以看到服务器应答成功了；之后就是正常的数据传输了。</p>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="https://frank0.top/2020/05/29/socks5%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" data-id="ckas0o9yj00007ks62ytmh5vn" class="article-share-link">
                                            分享
                                        </a>
                                        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android-socks5-proxy/" rel="tag">android socks5 proxy</a></li></ul>

                                    </footer>

    </div>

    
        
  <nav class="article-nav">
    
    
      <a href="/2020/05/07/%E5%95%86%E4%B8%9A%E7%9A%84%E6%9C%AC%E8%B4%A8%E4%B8%8E%E4%BA%92%E8%81%94%E7%BD%91%E7%95%A5%E8%AF%BB/" class="article-nav-link">
        <strong class="article-nav-caption">后一篇</strong>
        <div class="article-nav-title">商业的本质与互联网略读</div>
      </a>
    
  </nav>


            

                
                    
    <div class="vcomments" id="vcomments"></div>
    
<script src="https://unpkg.com/valine/dist/Valine.min.js"></script>

        <script>
            new Valine({
                el: '#vcomments',
                appId: 'Gh2oOlBjwQgEJQvtveG690Ko-gzGzoHsz',
                appKey: 'oX17NmUs7sFsGaG1Tgb7Nc9g',
                notify: 'false',
                verify: 'true',
                avatar: 'mp',
                pageSize: '10',
                placeholder: '请输入...'
            })
        </script>
        
                        
                            

</article>
</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
    <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 frank0&#39;s Blog</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean" target="_blank" rel="noopener">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="frank0&#39;s Blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>

<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>



<script src="/js/ocean.js"></script>


</body>
</html>